#!/usr/bin/python

import sys;
import re;
import os;
import os.path;
import subprocess;
import tempfile;

def usage():
    print >>sys.stderr, "Usage: %(prog)s [options] filename.tex" % {'prog': sys.argv[0]};
    exit(255);

if (len(sys.argv) < 2):
    usage();

if (not re.match(r'.*\.(la)?tex', sys.argv[-1])):
    usage();


# find pdflatex
pdflatex = subprocess.Popen("which pdflatex", shell=True, stderr=subprocess.STDOUT,
                            stdout=subprocess.PIPE).communicate()[0].strip();

if (not pdflatex):
    print >>sys.stderr, "Can't find pdflatex!";
    exit(255);
    

texfile = sys.argv[-1];
argv = sys.argv[1:-1];
solutions = False;
tipssheet = False;

runtexfile = None;

workdir = tempfile.mkdtemp();

# see if first flag is "--solutionssheet" or "--tipssheet"
if (argv and argv[0] == "--solutionssheet"):
    solutions = True;
    argv = argv[1:];
    runtexfile = os.path.join(workdir, re.sub(r'\.((la)?tex)$', r'_sol.\1', texfile));
    try:
        f = open(runtexfile, 'w');
        f.write(r'\def\ethuebungwantsolutions{}\input{'+texfile+'}' +'\n');
        f.close();
    except:
        print >>sys.stderr, "Can't open file %s." % [texfile];
elif (argv and argv[0] == "--tipssheet"):
    tipssheet = True;
    argv = argv[1:];
    runtexfile = os.path.join(workdir, re.sub(r'\.((la)?tex)$', r'_tips.\1', texfile));
    try:
        f = open(runtexfile, 'w');
        f.write(r'\def\ethuebungwanttipssheet{}\input{'+texfile+'}' +'\n');
        f.close();
    except:
        print >>sys.stderr, "Can't open file %s." % [texfile];
else:
    runtexfile = os.path.join(workdir, re.sub(r'\.((la)?tex)$', r'_ex.\1', texfile));
    try:
        f = open(runtexfile, 'w');
        f.write(r'\def\ethuebungwantexercisesheet{}\input{'+texfile+'}' +'\n');
        f.close();
    except:
        print >>sys.stderr, "Can't open file %s." % [texfile];

cmd = [pdflatex];
cmd += argv;
cmd += [runtexfile];

e = os.environ;
e['TEXINPUTS'] = os.getcwd()+":"+(e['TEXINPUTS'] if 'TEXINPUTS' in e else '');
e['BIBINPUTS'] = os.getcwd()+":"+(e['BIBINPUTS'] if 'BIBINPUTS' in e else '');

print repr(cmd);


def finished(code):
    if (not finished._cleaned_up):
        for f in os.listdir(workdir):
            os.remove(os.path.join(workdir, f))
        os.rmdir(workdir)
        finished._cleaned_up = True

    if (code < 0):
        sys.stderr.write("Child terminated by signal %d" %(-code));
        exit(-code);

    exit(code);
#
# "Static" variable for our function finished()
finished._cleaned_up = False


#
# Run pdflatex up to three times
#
try:
    code = 0;
    for n in xrange(3):
        code = subprocess.call(cmd, env=e);
        if (code != 0):
            finished(code);

    finished(0)
except SystemExit:
    raise
except KeyboardInterrupt:
    raise
except:
    import traceback;
    sys.stderr.write("EXCEPTION:\n%s" %(traceback.format_exc()));
    finished(255)
